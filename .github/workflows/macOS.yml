name: macOS
on: [workflow_dispatch]
jobs:
  build:
    runs-on: macos-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: Checkout tools repo
        uses: actions/checkout@v2
        with:
          repository: HydrologicEngineeringCenter/dss-test-data
          path: dss-test-data

      - name: cleanup macOS
        run: |
            sudo rm -rf /Applications/Xcode.app /Library/Developer/CommandLineTools
            sudo xcode-select --reset

      - name: install Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      - name: install gcc
        run: |
          brew install gcc@9

      - name: install openjdk
        run: |
          brew install openjdk@11

      - name: build main library
        run: |
          cd heclib
          make
        env:
          JAVA_HOME: /usr/local/Cellar/openjdk@11/11.0.12/libexec/openjdk.jdk/Contents/Home
          GFORTRAN_PATH: /usr/local/Cellar/gcc@9/9.4.0/lib/gcc/9

      - name: run C test
        run: |
          cd ../test/C
          chmod +x unix_test
          ./unix_test
